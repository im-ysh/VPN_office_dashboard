//package com.vpn.backend;
//
//import java.io.*;
//import java.sql.*;
//import javax.servlet.*;
//import javax.servlet.http.*;
//
//public class LoginServlet extends HttpServlet {
//    protected void doPost(HttpServletRequest request, HttpServletResponse response)
//            throws ServletException, IOException {
//        String username = request.getParameter("username");
//        String password = request.getParameter("password");
//
//        try (Connection conn = DBUtil.getConnection()) {
//            String sql = "SELECT role FROM vpn_users WHERE username = ? AND password = ?";
//            PreparedStatement stmt = conn.prepareStatement(sql);
//            stmt.setString(1, username);
//            stmt.setString(2, password);
//            
//            System.out.println("Received username: " + username);
//            System.out.println("Received password: " + password);
//
//            ResultSet rs = stmt.executeQuery();
//
//            response.setContentType("application/json");
//            PrintWriter out = response.getWriter();
//
//            if (rs.next()) {
//                String role = rs.getString("role");
//                
//             // Insert audit log
//                DBUtil.insertAuditLog(username, "LOGIN", "vpn_users", "User logged in successfully");
//                out.print("{\"status\":\"success\", \"message\":\"Login successful\", \"role\":\"" + role + "\"}");
//                out.flush();
//
////                out.print("{\"status\":\"success\", \"role\":\"" + role + "\"}");
//            } else {
//                out.print("{\"status\":\"fail\", \"message\":\"Invalid credentials\"}");
//            }
//        } catch (Exception e) {
//            throw new ServletException("DB error: " + e.getMessage());
//        }
//        
//    }
//
//    protected void doGet(HttpServletRequest request, HttpServletResponse response)
//            throws ServletException, IOException {
//        response.setContentType("application/json");
//        PrintWriter out = response.getWriter();
//        out.print("{\"status\":\"success\", \"message\":\"GET request working for LoginServlet\"}");
//    }
//}


protected void doPost(HttpServletRequest request, HttpServletResponse response) 
        throws ServletException, IOException {
    
    // 1. SET CORS HEADERS FIRST
    response.setHeader("Access-Control-Allow-Origin", "*"); 
    response.setContentType("application/json");
    PrintWriter out = response.getWriter();
    JSONObject json = new JSONObject();

    try {
        String username = request.getParameter("username");
        String password = request.getParameter("password");

        // 2. INPUT VALIDATION
        if(username == null || password == null) {
            json.put("status", "fail");
            json.put("message", "Missing credentials");
            response.setStatus(400);
            out.print(json.toString());
            return;
        }

        // 3. DATABASE OPERATION
        try (Connection conn = DBUtil.getConnection()) {
            PreparedStatement stmt = conn.prepareStatement(
                "SELECT role FROM vpn_users WHERE username=? AND password=?"
            );
            stmt.setString(1, username);
            stmt.setString(2, password);
            
            ResultSet rs = stmt.executeQuery();
            
            if(rs.next()) {
                // 4. SUCCESS RESPONSE
                json.put("status", "success");
                json.put("role", rs.getString("role"));
                DBUtil.insertAuditLog(username, "LOGIN", "vpn_users", "Success");
            } else {
                // 5. FAILED LOGIN
                json.put("status", "fail");
                json.put("message", "Invalid credentials");
                response.setStatus(401);
            }
        }
    } catch (SQLException e) {
        // 6. DATABASE ERROR
        json.put("status", "error");
        json.put("message", "Database error");
        response.setStatus(500);
        e.printStackTrace(); // Log to server console
    } catch (Exception e) {
        // 7. OTHER ERRORS
        json.put("status", "error");
        json.put("message", "Server error");
        response.setStatus(500);
        e.printStackTrace();
    } finally {
        // 8. GUARANTEED RESPONSE
        out.print(json.toString());
        out.flush();
    }
}
