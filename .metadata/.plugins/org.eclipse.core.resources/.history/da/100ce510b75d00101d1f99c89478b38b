package com.vpn.backend;

import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
import org.json.JSONArray;
import org.json.JSONObject;

@WebServlet("/active-users")
public class ActiveUsersServlet extends HttpServlet {
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        
        response.setContentType("application/json");
        PrintWriter out = response.getWriter();

        try (Connection conn = DBUtil.getConnection()) {
            Statement stmt = conn.createStatement();
            ResultSet rs = stmt.executeQuery("SELECT * FROM vpn_logs ORDER BY login_time DESC");

            JSONArray logs = new JSONArray();
            while (rs.next()) {
                JSONObject log = new JSONObject();
                log.put("username", rs.getString("username"));
                log.put("ip", rs.getString("tailscale_ip"));
                log.put("time", rs.getTimestamp("login_time"));
                logs.put(log);
            }
            out.print(logs.toString());

        } catch (Exception e) {
            out.print("{\"error\":\"" + e.getMessage() + "\"}");
        }
    }
}